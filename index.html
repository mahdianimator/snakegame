<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی مار | Snake Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            padding: 20px;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 500px;
        }
        
        .game-header {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .game-header h1 {
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }
        
        .score-container {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.5rem;
            width: 100%;
            text-align: center;
            display: flex;
            justify-content: space-between;
        }
        
        .high-score {
            color: #ffdd59;
        }
        
        .game-container {
            position: relative;
            width: 100%;
        }
        
        canvas {
            width: 100%;
            background-color: #111;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: block;
        }
        
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            color: white;
            text-align: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .overlay h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #ff4757;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .overlay p {
            font-size: 1.2rem;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .overlay .instruction {
            margin-top: 20px;
            color: #ffdd59;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            width: 100%;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .key {
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .gamepad-support {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            width: 100%;
        }
        
        @media (max-width: 600px) {
            .game-header h1 {
                font-size: 2rem;
            }
            
            .score-container {
                font-size: 1.2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .overlay h2 {
                font-size: 2rem;
            }
        }
        
        .snake-part {
            position: absolute;
            background-color: #2ed573;
            border-radius: 3px;
        }
        
        .snake-head {
            background-color: #00a8ff;
        }
        
        .food {
            position: absolute;
            background-color: #ff4757;
            border-radius: 50%;
        }
        
        .keyboard-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .key-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>بازی مار</h1>
        </div>
        
        <div class="score-container">
            <div>امتیاز: <span id="score">0</span></div>
            <div>بالاترین امتیاز: <span id="highScore" class="high-score">0</span></div>
        </div>
        
        <div class="game-container">
            <canvas id="gameCanvas"></canvas>
            
            <div id="gameOverOverlay" class="overlay hidden">
                <h2>Game Over!</h2>
                <p>مار به دیوار یا به خودش برخورد کرد!</p>
                <p>امتیاز شما: <span id="finalScore">0</span></p>
                <p class="instruction">برای شروع مجدد، دکمه R کیبورد یا Start در دسته بازی را فشار دهید.</p>
            </div>
            
            <div id="pauseOverlay" class="overlay hidden">
                <h2>توقف بازی</h2>
                <p>برای ادامه بازی، دکمه ESC کیبورد یا Start در دسته بازی را فشار دهید.</p>
                <p>برای شروع مجدد، دکمه R کیبورد یا Start در دسته بازی را فشار دهید.</p>
            </div>
            
            <div id="startOverlay" class="overlay">
                <h2>بازی مار</h2>
                <p>برای شروع بازی، دکمه Space کیبورد یا دکمه A در دسته بازی را فشار دهید.</p>
                <div class="keyboard-controls">
                    <div class="key-item">
                        <span class="key">↑</span>
                        <span>بالا</span>
                    </div>
                    <div class="key-item">
                        <span class="key">←</span>
                        <span>چپ</span>
                    </div>
                    <div class="key-item">
                        <span class="key">↓</span>
                        <span>پایین</span>
                    </div>
                    <div class="key-item">
                        <span class="key">→</span>
                        <span>راست</span>
                    </div>
                    <div class="key-item">
                        <span class="key">P</span>
                        <span>توقف</span>
                    </div>
                    <div class="key-item">
                        <span class="key">R</span>
                        <span>شروع مجدد</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <span class="key">↑</span>
                <span class="key">←</span>
                <span class="key">↓</span>
                <span class="key">→</span>
                <span>کنترل حرکت مار</span>
            </div>
            <div class="control-group">
                <span class="key">P</span>
                <span>توقف بازی</span>
            </div>
            <div class="control-group">
                <span class="key">ESC</span>
                <span>ادامه بازی</span>
            </div>
            <div class="control-group">
                <span class="key">R</span>
                <span>شروع مجدد</span>
            </div>
        </div>
        
        <div class="gamepad-support">
            <p>دسته بازی شناسایی شد: <span id="gamepadStatus">❌ متصل نیست</span></p>
        </div>
    </div>

    <script>
        // انتخاب المان‌های DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('highScore');
        const finalScoreElement = document.getElementById('finalScore');
        const gameOverOverlay = document.getElementById('gameOverOverlay');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const startOverlay = document.getElementById('startOverlay');
        const gamepadStatus = document.getElementById('gamepadStatus');
        
        // تنظیمات بازی
        const gridSize = 20;
        let tileCount;
        let snake = [];
        let food = {};
        let dx = 0;
        let dy = 0;
        let score = 0;
        let highScore = 0;
        let gameSpeed = 9;
        let gameOver = false;
        let paused = false;
        let gameStarted = false;
        let gameInterval;
        let gamepadConnected = false;
        
        // تنظیم اندازه Canvas
        function setupCanvas() {
            const size = Math.min(400, window.innerWidth - 40);
            canvas.width = size;
            canvas.height = size;
            tileCount = canvas.width / gridSize;
        }
        
        // مقداردهی اولیه بازی
        function initGame() {
            setupCanvas();
            
            snake = [
                { x: 10, y: 10 },
                { x: 9, y: 10 },
                { x: 8, y: 10 }
            ];
            
            generateFood();
            
            dx = 1;
            dy = 0;
            score = 0;
            gameOver = false;
            paused = false;
            gameStarted = true;
            
            scoreElement.textContent = score;
            gameOverOverlay.classList.add('hidden');
            pauseOverlay.classList.add('hidden');
            startOverlay.classList.add('hidden');
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, 1000 / gameSpeed);
        }
        
        // تولید غذا در موقعیت تصادفی
        function generateFood() {
            food = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };
            
            // اطمینان از اینکه غذا روی مار تولید نمی‌شود
            for (let part of snake) {
                if (part.x === food.x && part.y === food.y) {
                    return generateFood();
                }
            }
        }
        
        // حلقه اصلی بازی
        function gameLoop() {
            if (paused || gameOver || !gameStarted) return;
            
            update();
            draw();
        }
        
        // به روزرسانی وضعیت بازی
        function update() {
            // حرکت مار
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            
            // بررسی برخورد با دیوار
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                handleGameOver();
                return;
            }
            
            // بررسی برخورد با بدن مار
            for (let i = 0; i < snake.length; i++) {
                if (snake[i].x === head.x && snake[i].y === head.y) {
                    handleGameOver();
                    return;
                }
            }
            
            // اضافه کردن سر جدید
            snake.unshift(head);
            
            // بررسی خوردن غذا
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreElement.textContent = score;
                
                if (score > highScore) {
                    highScore = score;
                    highScoreElement.textContent = highScore;
                    localStorage.setItem('snakeHighScore', highScore);
                }
                
                generateFood();
                
                // افزایش سرعت بازی با افزایش امتیاز
                if (score % 50 === 0) {
                    gameSpeed += 1;
                    clearInterval(gameInterval);
                    gameInterval = setInterval(gameLoop, 1000 / gameSpeed);
                }
            } else {
                // اگر غذا نخورده باشد، دم حذف می‌شود
                snake.pop();
            }
        }
        
        // رسم بازی
        function draw() {
            // پاک کردن صفحه
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // رسم غذا
            ctx.fillStyle = '#ff4757';
            ctx.beginPath();
            ctx.arc(
                food.x * gridSize + gridSize / 2,
                food.y * gridSize + gridSize / 2,
                gridSize / 2,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // رسم مار
            for (let i = 0; i < snake.length; i++) {
                // سر مار
                if (i === 0) {
                    ctx.fillStyle = '#00a8ff';
                } else {
                    // بدن مار
                    ctx.fillStyle = '#2ed573';
                }
                
                ctx.fillRect(
                    snake[i].x * gridSize, 
                    snake[i].y * gridSize, 
                    gridSize - 1, 
                    gridSize - 1
                );
                
                // چشم‌های مار (فقط برای سر)
                if (i === 0) {
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(
                        snake[i].x * gridSize + gridSize / 4,
                        snake[i].y * gridSize + gridSize / 3,
                        gridSize / 6,
                        0,
                        Math.PI * 2
                    );
                    ctx.arc(
                        snake[i].x * gridSize + 3 * gridSize / 4,
                        snake[i].y * gridSize + gridSize / 3,
                        gridSize / 6,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
            }
        }
        
        // کنترل حرکت مار
        function changeDirection(event) {
            if (paused || gameOver || !gameStarted) return;
            
            const keyPressed = event.key;
            
            // جهت‌های مجاز بر اساس جهت فعلی
            if ((keyPressed === 'ArrowUp' || keyPressed === 'w' || keyPressed === 'W') && dy === 0) {
                dx = 0;
                dy = -1;
                event.preventDefault();
            } else if ((keyPressed === 'ArrowDown' || keyPressed === 's' || keyPressed === 'S') && dy === 0) {
                dx = 0;
                dy = 1;
                event.preventDefault();
            } else if ((keyPressed === 'ArrowLeft' || keyPressed === 'a' || keyPressed === 'A') && dx === 0) {
                dx = -1;
                dy = 0;
                event.preventDefault();
            } else if ((keyPressed === 'ArrowRight' || keyPressed === 'd' || keyPressed === 'D') && dx === 0) {
                dx = 1;
                dy = 0;
                event.preventDefault();
            }
        }
        
        // کنترل pause و restart
        function handleControl(event) {
            const keyPressed = event.key;
            
            if (keyPressed === 'r' || keyPressed === 'R') {
                // شروع مجدد بازی
                initGame();
                event.preventDefault();
            } else if ((keyPressed === 'p' || keyPressed === 'P') && !gameOver && gameStarted) {
                // توقف بازی
                paused = true;
                pauseOverlay.classList.remove('hidden');
                event.preventDefault();
            } else if (keyPressed === 'Escape' && !gameOver && gameStarted) {
                // ادامه بازی
                paused = false;
                pauseOverlay.classList.add('hidden');
                event.preventDefault();
            } else if (keyPressed === ' ' && !gameStarted) {
                // شروع بازی
                initGame();
                event.preventDefault();
            }
        }
        
        // مدیریت Game Over
        function handleGameOver() {
            gameOver = true;
            finalScoreElement.textContent = score;
            gameOverOverlay.classList.remove('hidden');
        }
        
        // پشتیبانی از دسته بازی
        function checkGamepad() {
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            
            for (let i = 0; i < gamepads.length; i++) {
                const gamepad = gamepads[i];
                if (gamepad && gamepad.connected) {
                    gamepadConnected = true;
                    gamepadStatus.textContent = '✅ ' + gamepad.id;
                    
                    // کنترل جهت با دسته بازی
                    if (Math.abs(gamepad.axes[0]) > 0.2 || Math.abs(gamepad.axes[1]) > 0.2) {
                        if (Math.abs(gamepad.axes[0]) > Math.abs(gamepad.axes[1])) {
                            // حرکت افقی
                            if (gamepad.axes[0] < -0.2 && dx === 0) {
                                dx = -1;
                                dy = 0;
                            } else if (gamepad.axes[0] > 0.2 && dx === 0) {
                                dx = 1;
                                dy = 0;
                            }
                        } else {
                            // حرکت عمودی
                            if (gamepad.axes[1] < -0.2 && dy === 0) {
                                dx = 0;
                                dy = -1;
                            } else if (gamepad.axes[1] > 0.2 && dy === 0) {
                                dx = 0;
                                dy = 1;
                            }
                        }
                    }
                    
                    // دکمه Start برای شروع/ادامه/ریستارت
                    if (gamepad.buttons[9].pressed) {
                        if (!gameStarted) {
                            initGame();
                        } else if (gameOver) {
                            initGame();
                        } else if (paused) {
                            paused = false;
                            pauseOverlay.classList.add('hidden');
                        }
                    }
                    
                    // دکمه A (معمولاً دکمه 0) برای شروع بازی
                    if (gamepad.buttons[0].pressed && !gameStarted) {
                        initGame();
                    }
                    
                    // دکمه B (معمولاً دکمه 1) یا Circle برای توقف بازی
                    if ((gamepad.buttons[1].pressed) && !gameOver && gameStarted) {
                        paused = true;
                        pauseOverlay.classList.remove('hidden');
                    }
                    
                    break;
                }
            }
            
            if (!gamepadConnected) {
                gamepadStatus.textContent = '❌ متصل نیست';
            }
            
            requestAnimationFrame(checkGamepad);
        }
        
        // بارگذاری بالاترین امتیاز از localStorage
        function loadHighScore() {
            const savedHighScore = localStorage.getItem('snakeHighScore');
            if (savedHighScore) {
                highScore = parseInt(savedHighScore);
                highScoreElement.textContent = highScore;
            }
        }
        
        // افزودن event listeners
        document.addEventListener('keydown', changeDirection);
        document.addEventListener('keydown', handleControl);
        window.addEventListener('resize', setupCanvas);
        
        // مقداردهی اولیه
        loadHighScore();
        setupCanvas();
        
        // شروع چک کردن دسته بازی
        if (navigator.getGamepads) {
            window.addEventListener('gamepadconnected', (event) => {
                gamepadConnected = true;
                gamepadStatus.textContent = '✅ ' + event.gamepad.id;
            });
            
            window.addEventListener('gamepaddisconnected', () => {
                gamepadConnected = false;
                gamepadStatus.textContent = '❌ متصل نیست';
            });
            
            requestAnimationFrame(checkGamepad);
        }
        
        // رسم صفحه شروع
        draw();
    </script>
</body>
</html>